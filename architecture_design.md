# 跨平台离线大模型运行时架构设计

## 1. 整体架构概述

本项目采用**PWA (Progressive Web App) + WebAssembly + Llama.cpp**的技术栈，实现跨平台、免安装、离线运行的大模型推理应用。架构设计遵循以下原则：

- **跨平台兼容性**：支持2015年起所有主流操作系统
- **免安装**：无需传统安装过程，通过浏览器即可运行
- **离线运行**：完全本地运行，不依赖任何外部API
- **轻量级**：软件包体积≤361MB
- **高性能**：通过模型量化和硬件优化确保流畅运行

## 2. 技术栈选择

### 2.1 核心技术

| 技术 | 用途 | 优势 |
|------|------|------|
| **PWA** | 跨平台应用框架 | 离线能力、桌面图标、推送通知 |
| **WebAssembly** | 高性能代码执行 | 接近原生性能、跨平台兼容 |
| **Llama.cpp** | 大模型推理引擎 | 轻量级C++实现、多级量化支持 |
| **GGUF** | 模型文件格式 | 高效压缩、跨平台兼容 |
| **Service Worker** | 离线缓存 | 资源预加载、离线访问 |
| **IndexedDB** | 本地存储 | 大文件存储、持久化 |

### 2.2 模型量化策略

为了实现100MB以内的软件体积，采用以下量化方案：

- **2-bit量化**：IQ1/2格式，最小模型体积
- **4-bit量化**：Q4_K_M格式，平衡体积和性能
- **8-bit量化**：Q8_0格式，最佳性能

## 3. 各平台兼容性策略

### 3.1 操作系统支持矩阵

| 操作系统 | 最低版本 | 发布年份 | 浏览器支持 |
|---------|---------|---------|-----------|
| Windows | Windows 7 | 2009 | Chrome 45+, Firefox 44+, Edge 12+ |
| macOS | OS X Yosemite (10.10) | 2014 | Safari 9+, Chrome 45+, Firefox 44+ |
| Android | Android 5.0 (Lollipop) | 2014 | Chrome 45+, Firefox 44+ |
| iOS | iOS 9.0 | 2015 | Safari 9+ |
| HarmonyOS (PC) | HarmonyOS 2.0 | 2021 | 华为浏览器 |
| HarmonyOS (手机) | HarmonyOS 2.0 | 2021 | 华为浏览器 |

### 3.2 浏览器兼容性

- **WebAssembly支持**：所有现代浏览器(2015年后发布)
- **Service Worker支持**：除IE外的所有主流浏览器
- **IndexedDB支持**：所有现代浏览器

### 3.3 性能优化

针对不同硬件平台，采用以下优化策略：

- **CPU优化**：SIMD指令集、多线程推理
- **内存优化**：动态权重卸载、内存池管理
- **存储优化**：LZ4压缩、增量更新

## 4. 系统架构分层

### 4.1 应用层

- **WebUI界面**：响应式设计，适配不同设备
- **用户交互**：模型选择、参数配置、推理结果展示
- **多语言支持**：中文/英文界面

### 4.2 API层

- **模型管理**：模型下载、安装、更新
- **推理控制**：启动/停止推理、参数调整
- **状态监控**：CPU/内存占用、推理进度

### 4.3 推理层

- **Llama.cpp核心**：WebAssembly编译的推理引擎
- **模型加载**：GGUF格式模型解析
- **推理执行**：量化推理、上下文管理

### 4.4 系统适配层

- **硬件检测**：CPU架构、内存大小、存储空间
- **性能适配**：根据硬件选择最优量化级别
- **资源管理**：内存分配、缓存策略

## 5. 模型管理

### 5.1 模型存储

- **内置基础模型**：2-bit量化的微型模型(~20MB)
- **可扩展模型**：支持用户手动导入其他GGUF格式模型
- **增量更新**：仅更新模型差异部分

### 5.2 模型优化

- **动态量化**：根据设备性能自动选择量化级别
- **权重压缩**：LZ4压缩算法减少存储占用
- **内存映射**：大模型文件内存映射，减少加载时间

## 6. 性能优化策略

### 6.1 内存优化

- **动态权重卸载**：将不常用的模型权重卸载到磁盘
- **内存池管理**：减少内存分配开销
- **上下文复用**：避免重复计算

### 6.2 计算优化

- **SIMD加速**：利用CPU SIMD指令集加速计算
- **多线程推理**：充分利用多核CPU
- **WebAssembly优化**：编译时优化、内存对齐

### 6.3 存储优化

- **LZ4压缩**：模型文件和资源压缩
- **增量更新**：仅下载变化部分
- **缓存策略**：智能缓存常用资源

## 7. 文件组织方案

按照操作系统、年份和版本进行文件组织：

```
连析工坊/
├── 2015/
│   ├── Windows/
│   │   ├── 7/
│   │   │   └── 连析工坊.exe
│   │   └── 10/
│   │       └── 连析工坊.exe
│   ├── macOS/
│   │   └── 10.10/
│   │       └── 连析工坊.app
│   ├── Android/
│   │   └── 5.0/
│   │       └── 连析工坊.apk
│   └── iOS/
│       └── 9.0/
│           └── 连析工坊.ipa
├── 2021/
│   ├── Windows/
│   │   └── 11/
│   │       └── 连析工坊.exe
│   ├── macOS/
│   │   └── 12.0/
│   │       └── 连析工坊.app
│   ├── Android/
│   │   └── 12/
│   │       └── 连析工坊.apk
│   ├── iOS/
│   │   └── 15.0/
│   │       └── 连析工坊.ipa
│   └── HarmonyOS/
│       ├── PC/
│       │   └── 2.0/
│       │       └── 连析工坊.exe
│       └── 手机/
│           └── 2.0/
│               └── 连析工坊.hap
└── 2025/
    └── ...
```

## 8. 部署和分发

### 8.1 签名和证书

- 使用官方发布签名确保软件安全性
- 支持Windows、macOS、Android、iOS的官方证书签名

### 8.2 分发渠道

- **官方网站**：直接下载各平台版本
- **应用商店**：通过各平台官方应用商店分发
- **PWA安装**：通过浏览器直接添加到桌面

## 9. 测试和验证

### 9.1 兼容性测试

- **自动化测试**：使用Selenium和Appium进行跨平台测试
- **手动测试**：在实际设备上验证功能和性能
- **性能测试**：测量不同设备上的推理速度和内存占用

### 9.2 性能指标

- **启动时间**：≤5秒
- **推理速度**：≥5 tokens/秒(在2015年主流设备上)
- **内存占用**：≤500MB(在2015年主流设备上)
- **模型加载时间**：≤30秒

## 10. 未来扩展

- **多模态支持**：图片、音频等多模态输入
- **模型微调**：支持用户在本地微调模型
- **硬件加速**：GPU、NPU等硬件加速支持
- **分布式推理**：多设备协同推理

---

本架构设计确保了应用在2015年起所有主流操作系统上的兼容性、性能和用户体验，同时满足了免安装、离线运行和轻量级的要求。